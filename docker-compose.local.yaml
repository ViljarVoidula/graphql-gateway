volumes:
  redis:
    name: redis_data
  mongo-data:
    name: mongo_data
  mongo-config:
    name: mongo_config

networks:
  gateway_net:
    name: gateway_net
    driver: bridge

services:
  mongo:
    image: mongo:8.0
    container_name: mongodb
    restart: always
    ports:
      - '27017:27017'
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: password
    volumes:
      - mongo-data:/data/db # Persist MongoDB data
      - mongo-config:/data/configdb # Persist MongoDB configuration
    networks:
      - gateway_net
  redis:
    container_name: gateway-redis
    image: redis:7.4.1-alpine
    restart: always
    ports:
      - '26379:6379' # Changed from 16379 to 26379
    volumes:
      - redis:/data
    environment:
      - ALLOW_EMPTY_PASSWORD=yes
      - REDIS_DISABLE_COMMANDS=FLUSHDB,FLUSHALL
    networks:
      - gateway_net
  # redis for tests
  test-redis:
    container_name: test-redis
    image: redis:7.4.1-alpine
    restart: always
    ports:
      - '6379:6379'
    volumes:
      - redis:/data
    environment:
      - ALLOW_EMPTY_PASSWORD=yes
      - REDIS_DISABLE_COMMANDS=FLUSHDB,FLUSHALL
    networks:
      - gateway_net
  vespa:
    image: vespaengine/vespa:8.578.22
    container_name: vespa
    hostname: vespa-container
    ports:
      - '8100:8080' # query / document API
      - '19071:19071' # config / deploy API
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:19071/state/v1/health']
      interval: 10s
      timeout: 5s
      retries: 30
    networks:
      - gateway_net
